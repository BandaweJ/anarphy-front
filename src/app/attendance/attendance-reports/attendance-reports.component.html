<div class="reports-container">
  <!-- Header Section -->
  <div class="header-section">
    <div class="title-toolbar">
      <div class="toolbar-content">
        <div class="title-section">
          <mat-icon class="title-icon">assessment</mat-icon>
          <h1 class="page-title">{{ title.getTitle() }}</h1>
        </div>
      </div>
    </div>
  </div>

  <!-- Selection Section -->
  <div class="selection-section">
    <div class="selection-card">
      <div class="card-header">
        <div class="header-content">
          <mat-icon class="section-icon">filter_list</mat-icon>
          <div class="header-text">
            <h2 class="section-title">Generate Reports</h2>
            <p class="section-subtitle">Select class and term to generate attendance reports</p>
          </div>
        </div>
      </div>
      <div class="card-content">
        <form [formGroup]="reportsForm" (ngSubmit)="generateReports()">
          <div class="form-fields">
            <div class="form-field">
              <mat-form-field appearance="outline">
                <mat-label>Choose Term</mat-label>
                <mat-select formControlName="term">
                  <mat-option *ngFor="let term of terms$ | async" [value]="term">
                    Term {{ term.num }} {{ term.year }}
                  </mat-option>
                </mat-select>
                <mat-icon matSuffix>calendar_today</mat-icon>
                <mat-hint>Select the academic term</mat-hint>
                <mat-error *ngIf="term?.invalid && term?.touched">
                  {{ getFormErrorMessage('term') }}
                </mat-error>
              </mat-form-field>
            </div>
            <div class="form-field">
              <mat-form-field appearance="outline">
                <mat-label>Choose Class</mat-label>
                <mat-select formControlName="clas">
                  <mat-option *ngFor="let clas of classes$ | async" [value]="clas.name">
                    {{ clas.name }}
                  </mat-option>
                </mat-select>
                <mat-icon matSuffix>class</mat-icon>
                <mat-hint>Select the class</mat-hint>
                <mat-error *ngIf="clas?.invalid && clas?.touched">
                  {{ getFormErrorMessage('clas') }}
                </mat-error>
              </mat-form-field>
            </div>
            <div class="form-field">
              <button
                mat-raised-button
                type="submit"
                color="primary"
                [disabled]="reportsForm.invalid"
                class="generate-button"
              >
                <mat-icon>assessment</mat-icon>
                Generate Reports
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Overall Stats Section -->
  <div class="overall-stats-section" *ngIf="attendanceReports$ | async as reports">
    <div class="stats-card" *ngIf="hasReports(reports)">
      <div class="card-header">
        <div class="header-content">
          <mat-icon class="section-icon">analytics</mat-icon>
          <div class="header-text">
            <h2 class="section-title">Overall Statistics</h2>
            <p class="section-subtitle">{{ reports.className }} - Term {{ reports.termNum }}, {{ reports.year }}</p>
          </div>
        </div>
        <div class="export-button-container">
          <button
            mat-raised-button
            color="accent"
            (click)="exportToPDF()"
            class="export-button"
          >
            <mat-icon>picture_as_pdf</mat-icon>
            Export to PDF
          </button>
        </div>
      </div>
      <div class="card-content">
        <div class="stats-grid">
          <div class="stat-item total-students">
            <mat-icon class="stat-icon">group</mat-icon>
            <div class="stat-content">
              <div class="stat-label">Total Students</div>
              <div class="stat-value">{{ reports.totalStudents }}</div>
            </div>
          </div>
          <div class="stat-item possible">
            <mat-icon class="stat-icon">event_available</mat-icon>
            <div class="stat-content">
              <div class="stat-label">Possible Attendance</div>
              <div class="stat-value">{{ reports.overallStats.totalPossibleAttendance }}</div>
            </div>
          </div>
          <div class="stat-item actual">
            <mat-icon class="stat-icon">check_circle</mat-icon>
            <div class="stat-content">
              <div class="stat-label">Actual Attendance</div>
              <div class="stat-value">{{ reports.overallStats.totalActualAttendance }}</div>
            </div>
          </div>
          <div class="stat-item rate">
            <mat-icon class="stat-icon">trending_up</mat-icon>
            <div class="stat-content">
              <div class="stat-label">Overall Attendance Rate</div>
              <div class="stat-value">{{ reports.overallStats.overallAttendanceRate }}%</div>
            </div>
          </div>
          <div class="stat-item days">
            <mat-icon class="stat-icon">calendar_today</mat-icon>
            <div class="stat-content">
              <div class="stat-label">Days Marked</div>
              <div class="stat-value">{{ reports.overallStats.totalDaysMarked }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Weekly Summaries Section -->
  <div class="weekly-section" *ngIf="attendanceReports$ | async as reports">
    <div class="weekly-card" *ngIf="hasReports(reports) && reports.weeklySummaries.length > 0">
      <div class="card-header">
        <div class="header-content">
          <mat-icon class="section-icon">view_week</mat-icon>
          <div class="header-text">
            <h2 class="section-title">Weekly Attendance Summary</h2>
            <p class="section-subtitle">Weekly totals of actual attendance</p>
          </div>
        </div>
      </div>
      <div class="card-content">
        <div class="weekly-table-container">
          <table class="weekly-table">
            <thead>
              <tr>
                <th>Week</th>
                <th>Start Date</th>
                <th>End Date</th>
                <th>Possible Attendance</th>
                <th>Actual Attendance</th>
                <th>Average Rate</th>
                <th>Days Marked</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let week of reports.weeklySummaries">
                <td><strong>Week {{ week.weekNumber }}</strong></td>
                <td>{{ formatDate(week.weekStartDate) }}</td>
                <td>{{ formatDate(week.weekEndDate) }}</td>
                <td>{{ week.totalPossibleAttendance }}</td>
                <td>{{ week.totalActualAttendance }}</td>
                <td>
                  <span class="rate-badge" [ngClass]="getRateClass(week.averageAttendanceRate)">
                    {{ week.averageAttendanceRate }}%
                  </span>
                </td>
                <td>{{ week.daysWithAttendance }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Trends Section -->
  <div class="trends-section" *ngIf="attendanceReports$ | async as reports">
    <div class="trends-card" *ngIf="hasReports(reports) && reports.trends.length > 0">
      <div class="card-header">
        <div class="header-content">
          <mat-icon class="section-icon">show_chart</mat-icon>
          <div class="header-text">
            <h2 class="section-title">Attendance Trends</h2>
            <p class="section-subtitle">Weekly attendance trends</p>
          </div>
        </div>
      </div>
      <div class="card-content">
        <div class="trends-list">
          <div class="trend-item" *ngFor="let trend of reports.trends">
            <div class="trend-period">{{ trend.period }}</div>
            <div class="trend-rate">{{ trend.attendanceRate }}%</div>
            <div class="trend-indicator" [ngClass]="'trend-' + trend.trend">
              <mat-icon>{{ getTrendIcon(trend.trend) }}</mat-icon>
              <span>{{ trend.trend }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Daily Metrics Section -->
  <div class="daily-section" *ngIf="attendanceReports$ | async as reports">
    <div class="daily-card" *ngIf="hasReports(reports)">
      <div class="card-header">
        <div class="header-content">
          <mat-icon class="section-icon">table_chart</mat-icon>
          <div class="header-text">
            <h2 class="section-title">Daily Attendance Metrics</h2>
            <p class="section-subtitle">Number absent, actual attendance, possible attendance, and absent students per date</p>
          </div>
        </div>
      </div>
      <div class="card-content">
        <div class="daily-metrics-container">
          <div class="daily-metric-item" *ngFor="let day of reports.dailyMetrics">
            <div class="date-header">
              <mat-icon class="date-icon">event</mat-icon>
              <h3 class="date-title">{{ formatDate(day.date) }}</h3>
            </div>
            <div class="metrics-row">
              <div class="metric-box possible">
                <div class="metric-label">Possible Attendance</div>
                <div class="metric-value">{{ day.possibleAttendance }}</div>
              </div>
              <div class="metric-box actual">
                <div class="metric-label">Actual Attendance</div>
                <div class="metric-value">{{ day.actualAttendance }}</div>
              </div>
              <div class="metric-box absent">
                <div class="metric-label">Number Absent</div>
                <div class="metric-value">{{ day.absentCount }}</div>
              </div>
              <div class="metric-box rate">
                <div class="metric-label">Attendance Rate</div>
                <div class="metric-value">{{ day.attendanceRate }}%</div>
              </div>
            </div>
            <div class="absent-students-section" *ngIf="day.absentStudents.length > 0">
              <h4 class="absent-header">
                <mat-icon>person_off</mat-icon>
                Absent Students ({{ day.absentStudents.length }})
              </h4>
              <div class="absent-students-list">
                <div class="absent-student-item" *ngFor="let student of day.absentStudents">
                  <div class="student-info">
                    <span class="student-number">{{ student.studentNumber }}</span>
                    <span class="student-name">{{ student.surname }}, {{ student.name }}</span>
                    <span class="student-gender">{{ student.gender }}</span>
                  </div>
                </div>
              </div>
            </div>
            <div class="no-absent-message" *ngIf="day.absentStudents.length === 0">
              <mat-icon>check_circle</mat-icon>
              <span>All students present</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div class="empty-state" *ngIf="!(attendanceReports$ | async) && !(isLoading$ | async)">
    <div class="empty-card">
      <div class="empty-content">
        <mat-icon class="empty-icon">assessment</mat-icon>
        <h2>No Reports Generated</h2>
        <p>Select a class and term to generate attendance reports.</p>
      </div>
    </div>
  </div>

  <!-- Empty Reports State -->
  <ng-container *ngIf="(attendanceReports$ | async) as reports">
    <div class="empty-state" *ngIf="!hasReports(reports) && !(isLoading$ | async)">
      <div class="empty-card">
        <div class="empty-content">
          <mat-icon class="empty-icon">table_chart</mat-icon>
          <h2>No Attendance Records Found</h2>
          <p>No attendance records were found for the selected class and term. Please ensure attendance has been marked for this class.</p>
        </div>
      </div>
    </div>
  </ng-container>

  <!-- Loading State -->
  <div class="loading-container" *ngIf="isLoading$ | async">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Generating reports...</p>
  </div>
</div>

